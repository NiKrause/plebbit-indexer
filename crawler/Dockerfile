FROM node:20

WORKDIR /app

# Install netcat for the wait script
RUN apt-get update

COPY package.json ./
RUN npm install

# Accept build arguments
ARG PLEBBIT_WS_URL
ARG OPENROUTER_API_KEY
ARG OPENROUTER_MODEL
ARG OPENROUTER_MODEL_B
ARG OPENROUTER_MODEL_C
ARG SITE_URL
ARG SITE_NAME
ARG CONTENT_MODERATION_INTERVAL
ARG QUEUE_REFRESH_INTERVAL
ARG DUNE_API_KEY
ARG DUNE_QUERY_ID
ARG DUNE_QUERY_EXECUTE_INTERVAL_HOURS
ARG DUNE_QUERY_FETCH_INTERVAL_HOURS

# Set environment variables
ENV PLEBBIT_WS_URL=$PLEBBIT_WS_URL
ENV OPENROUTER_API_KEY=$OPENROUTER_API_KEY
ENV OPENROUTER_MODEL=$OPENROUTER_MODEL
ENV OPENROUTER_MODEL_B=$OPENROUTER_MODEL_B
ENV OPENROUTER_MODEL_C=$OPENROUTER_MODEL_C
ENV SITE_URL=$SITE_URL
ENV SITE_NAME=$SITE_NAME
ENV CONTENT_MODERATION_INTERVAL=$CONTENT_MODERATION_INTERVAL
ENV QUEUE_REFRESH_INTERVAL=$QUEUE_REFRESH_INTERVAL
ENV DUNE_API_KEY=$DUNE_API_KEY
ENV DUNE_QUERY_ID=$DUNE_QUERY_ID
ENV DUNE_QUERY_EXECUTE_INTERVAL_HOURS=$DUNE_QUERY_EXECUTE_INTERVAL_HOURS
ENV DUNE_QUERY_FETCH_INTERVAL_HOURS=$DUNE_QUERY_FETCH_INTERVAL_HOURS

COPY . .

# Make the wait script executable
COPY wait-for-plebbit.sh /app/
RUN chmod +x /app/wait-for-plebbit.sh

# Use the wait script as entrypoint
ENTRYPOINT ["/app/wait-for-plebbit.sh"]
